
<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Contacto</title>
    <link rel="stylesheet" href="contacto.css" />
    <link rel="stylesheet" href="EstiloPrincipal.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&family=Poppins:wght@500;700;800&display=swap" rel="stylesheet">
  </head>
  <body>
    <header>
        <nav>
            <!-- Logo como imagen -->
            <a href="home.html"><img src="../Imagenes/NYURAlogopagina.png" alt="Nyura Motors" class="logo-img"></a>
            
            <ul>
                <li><a href="home.html">Inicio</a></li>
                <li><a href="Gama.html">Modelos</a></li>
                <li><a href="Configurador3D.html">Configurador 3D</a></li>
                <li><a href="contacto.html">Contacto</a></li>
                <li id="authMenu"><a href="InicioSesion.html"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" style="width: 16px; height: 16px; vertical-align: -2px; margin-right: 6px;"><path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-4.41 0-8 2-8 4.5V21h16v-2.5c0-2.5-3.59-4.5-8-4.5Z"/></svg>Iniciar sesi√≥n</a></li>
            </ul>
        </nav>
    </header>
    <main class="page">
      <section class="shell">
        <div class="hero">
          <div class="hero__copy">
            <p class="hero__kicker">Nyura Motors</p>
            <h1 class="hero__title">Contacto</h1>
            <p class="hero__subtitle">
              ¬øTienes dudas sobre nuestros veh√≠culos o quieres reservar una prueba? Escr√≠benos y
              te responderemos lo antes posible.
            </p>
          </div>
        </div>

        <section class="grid">
          <div class="panel">
            <h2 class="panel__title">Informaci√≥n</h2>
            <p class="panel__text">
              Te atendemos de lunes a viernes. Si lo prefieres, tambi√©n puedes contactarnos por
              correo o visitarnos.
            </p>

            <div class="cards">
              <div class="card">
                <div class="card__icon" aria-hidden="true">@</div>
                <div class="card__body">
                  <p class="card__label">Email</p>
                  <p class="card__value">contacto@nyuramotors.com</p>
                </div>
              </div>

              <div class="card">
                <div class="card__icon" aria-hidden="true">‚òé</div>
                <div class="card__body">
                  <p class="card__label">Tel√©fono</p>
                  <p class="card__value">+34 612 345 678</p>
                </div>
              </div>

              <div class="card">
                <div class="card__icon" aria-hidden="true">‚åÇ</div>
                <div class="card__body">
                  <p class="card__label">Direcci√≥n</p>
                  <p class="card__value">Carrer de Caracas, 11. Sant Andreu, 08030 Barcelona</p>
                </div>
              </div>

              <div class="card">
                <div class="card__icon" aria-hidden="true">‚è±</div>
                <div class="card__body">
                  <p class="card__label">Horario</p>
                  <p class="card__value">Lunes a Viernes ¬∑ 09:00 ‚Äî 13:00 / 15:00 ‚Äî 19:00</p>
                </div>
              </div>
            </div>

            <div class="note" role="note">
              <p class="note__title">Nota</p>
              <p class="note__text">
                Este formulario es solo visual.
              </p>
            </div>
          </div>

          <div class="panel panel--form">
            <h2 class="panel__title">Env√≠anos un mensaje</h2>
            <form class="form" action="#" method="post" novalidate>
              <div class="form__row">
                <label class="field">
                  <span class="field__label">Nombre</span>
                  <input class="field__input" type="text" name="nombre" placeholder="Tu nombre" />
                </label>

                <label class="field">
                  <span class="field__label">Apellidos</span>
                  <input class="field__input" type="text" name="apellidos" placeholder="Tus apellidos" />
                </label>
              </div>

              <div class="form__row">
                <label class="field">
                  <span class="field__label">Email</span>
                  <input class="field__input" type="email" name="email" placeholder="nombre@correo.com" />
                </label>

                <label class="field">
                  <span class="field__label">Tel√©fono</span>
                  <input class="field__input" type="tel" name="telefono" placeholder="+34 600 000 000" />
                </label>
              </div>

              <label class="field">
                <span class="field__label">Asunto</span>
                <input class="field__input" type="text" name="asunto" placeholder="¬øSobre qu√© quieres hablar?" required />
              </label>

              <label class="field">
                <span class="field__label">Mensaje</span>
                <textarea
                  class="field__input field__input--textarea"
                  name="mensaje"
                  rows="6"
                  placeholder="Cu√©ntanos qu√© necesitas..."
                  required
                ></textarea>
              </label>

              <label class="check">
                <input class="check__input" type="checkbox" id="privacyCheck" required />
                <span class="check__box" aria-hidden="true"></span>
                <span class="check__text">He le√≠do y acepto la pol√≠tica de privacidad</span>
              </label>

              <div class="actions">
                <button class="btn" type="submit" id="submitBtn">Enviar</button>
              </div>
            </form>
          </div>
        </section>
      </section>
    </main>
    <footer>
    <div class="footer-content">
        <!-- Nyura Motors -->
        <div class="footer-section">
            <img src="../Imagenes/LogoBlancoNyura.png" alt="Nyura Motors" class="logo-img" style="height: 143px; opacity: 0.9;">
            <p>El futur de la mobilitat el√®ctrica. Disseny innovador, rendiment superior i tecnologia punta.</p>
        </div>

        <!-- Enlla√ßos principals -->
        <div class="footer-section">
            <h3>Paginas de Nyura Motors</h3>
            <div class="footer-links">
                <a href="home.html">Home</a>
                <a href="Gama.html">Modelos</a>
                <a href="Configurador3D.html">Configurador 3D</a>
                <a href="contacto.html">Contacto</a>
            </div>
        </div>

        

        <!-- Contacte & Xarxes -->
        <div class="footer-section">
            <h3>Contacte</h3>
            <p>üìß contacto@nyuramotors.com<br>
               üì± +34 612 345 678<br>
               üìç Carrer de Caracas, 11. Sant Andreu, 08030 Barcelona</p>
            <div class="social-links">
                <a href="#" aria-label="Twitter">ùïè</a>
                <a href="#" aria-label="Instagram">üì∑</a>
                <a href="#" aria-label="YouTube">üì∫</a>
                <a href="#" aria-label="LinkedIn">üíº</a>
            </div>
        </div>
    </div>
    
    <div class="footer-bottom">
        <p>&copy; 2026 Nyura Motors. Tots els drets reservats. | 
           <a href="#" style="color: #4A6FFF;">Pol√≠tica de Privacitat</a> | 
           <a href="#" style="color: #4A6FFF;">Condicions d'√∫s</a> | 
           <a href="#" style="color: #4A6FFF;">Cookies</a>
        </p>
    </div>
</footer>
<script type="module">
        import { getCurrentUser, createOrUpdateUserProfile, onAuthStateChange, signOut, createFormContacto, getUserByEmail } from '../controlador/BBDD/SupabaseCliente.js';
        
        document.addEventListener('DOMContentLoaded', async function() {
            const authMenu = document.getElementById('authMenu');
            const contactForm = document.querySelector('.form');
            const submitBtn = document.getElementById('submitBtn');
            const privacyCheck = document.getElementById('privacyCheck');
            
            // Funci√≥n para actualizar el men√∫ de autenticaci√≥n
            function updateAuthMenu(user) {
                if (user) {
                    const displayName = user.user_metadata?.nombre || user.email.split('@')[0];
                    authMenu.innerHTML = `
                        <div class="auth-dropdown">
                            <button class="auth-dropdown-toggle" onclick="toggleAuthMenu()">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" style="width: 16px; height: 16px; vertical-align: -2px; margin-right: 6px;">
                                    <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-4.41 0-8 2-8 4.5V21h16v-2.5c0-2.5-3.59-4.5-8-4.5Z"/>
                                </svg>
                                ${displayName}
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" style="width: 12px; height: 12px; margin-left: 4px;">
                                    <path d="M7 10l5 5 5-5z"/>
                                </svg>
                            </button>
                            <div class="auth-dropdown-menu" id="authDropdownMenu">
                                <a href="#" onclick="viewProfile()">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" style="width: 16px; height: 16px; margin-right: 8px;">
                                        <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-4.41 0-8 2-8 4.5V21h16v-2.5c0-2.5-3.59-4.5-8-4.5Z"/>
                                    </svg>
                                    Ver perfil
                                </a>
                                <a href="#" onclick="handleSignOut()" style="color: #dc3545;">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" style="width: 16px; height: 16px; margin-right: 8px;">
                                        <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5-5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
                                    </svg>
                                    Cerrar sesi√≥n
                                </a>
                            </div>
                        </div>
                    `;
                } else {
                    authMenu.innerHTML = `
                        <a href="InicioSesion.html">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" style="width: 16px; height: 16px; vertical-align: -2px; margin-right: 6px;">
                                <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-4.41 0-8 2-8 4.5V21h16v-2.5c0-2.5-3.59-4.5-8-4.5Z"/>
                            </svg>
                            Iniciar sesi√≥n
                        </a>
                    `;
                }
            }
            
            // Funci√≥n para toggle del men√∫ desplegable
            window.toggleAuthMenu = function() {
                const menu = document.getElementById('authDropdownMenu');
                menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            };
            
            // Funci√≥n para ver perfil
            window.viewProfile = function() {
                const currentUser = getCurrentUser();
                if (currentUser) {
                    const displayName = currentUser.user_metadata?.nombre || currentUser.email.split('@')[0];
                    alert(`Perfil de ${displayName}\n\nEmail: ${currentUser.email}\nTel√©fono: ${currentUser.user_metadata?.telefono || 'No especificado'}`);
                }
                toggleAuthMenu(); // Cerrar el men√∫
            };
            
            // Funci√≥n para cerrar sesi√≥n
            window.handleSignOut = async function() {
                try {
                    const result = await signOut();
                    if (result.success) {
                        console.log('Sesi√≥n cerrada correctamente');
                        updateAuthMenu(null);
                        // Opcional: redirigir a p√°gina de login
                        // window.location.href = 'InicioSesion.html';
                    } else {
                        console.error('Error al cerrar sesi√≥n:', result.error);
                        alert('Error al cerrar sesi√≥n. Intenta de nuevo.');
                    }
                } catch (error) {
                    console.error('Error inesperado al cerrar sesi√≥n:', error);
                    alert('Error inesperado. Intenta de nuevo.');
                }
            };
            
            // Cerrar men√∫ al hacer clic fuera
            document.addEventListener('click', function(event) {
                const dropdown = document.querySelector('.auth-dropdown');
                if (dropdown && !dropdown.contains(event.target)) {
                    const menu = document.getElementById('authDropdownMenu');
                    if (menu) {
                        menu.style.display = 'none';
                    }
                }
            });
            
            // Manejo del formulario de contacto
            if (contactForm) {
                // Funci√≥n para autorrellenar datos del usuario
                async function autoFillUserData() {
                    try {
                        console.log('Intentando autorrellenar datos del usuario...');
                        const currentUser = await getCurrentUser();
                        if (currentUser) {
                            console.log('Usuario logueado encontrado:', currentUser);
                            
                            // Obtener datos adicionales del usuario desde la tabla users
                            const userData = await getUserByEmail(currentUser.email);
                            console.log('Datos del usuario desde BD:', userData);
                            
                            // Rellenar nombre
                            const nombreInput = contactForm.querySelector('input[name="nombre"]');
                            const apellidosInput = contactForm.querySelector('input[name="apellidos"]');
                            const emailInput = contactForm.querySelector('input[name="email"]');
                            const telefonoInput = contactForm.querySelector('input[name="telefono"]');
                            
                            if (nombreInput && userData) {
                                // Si tenemos datos de la tabla users, usar el nombre completo
                                const nombreCompleto = userData.nombre || '';
                                const partes = nombreCompleto.split(' ');
                                nombreInput.value = partes[0] || '';
                                if (apellidosInput && partes.length > 1) {
                                    apellidosInput.value = partes.slice(1).join(' ');
                                }
                            } else if (nombreInput && currentUser.user_metadata?.nombre) {
                                // Usar metadata de auth
                                const nombreCompleto = currentUser.user_metadata.nombre;
                                const partes = nombreCompleto.split(' ');
                                nombreInput.value = partes[0] || '';
                                if (apellidosInput && partes.length > 1) {
                                    apellidosInput.value = partes.slice(1).join(' ');
                                }
                            }
                            
                            // Rellenar email
                            if (emailInput) {
                                emailInput.value = currentUser.email;
                                emailInput.readOnly = true; // Hacer el campo de solo lectura
                                emailInput.style.backgroundColor = '#f5f5f5';
                            }
                            
                            // Rellenar tel√©fono si est√° disponible
                            if (telefonoInput && userData?.telefono) {
                                telefonoInput.value = userData.telefono;
                            } else if (telefonoInput && currentUser.user_metadata?.telefono) {
                                telefonoInput.value = currentUser.user_metadata.telefono;
                            }
                            
                            console.log('Formulario autorrellenado correctamente');
                        } else {
                            console.log('No hay usuario logueado, formulario vac√≠o');
                        }
                    } catch (error) {
                        console.error('Error al autorrellenar formulario:', error);
                    }
                }
                
                // Llamar a autorrellenar cuando se carga la p√°gina
                autoFillUserData();
                
                contactForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Validar checkbox de privacidad
                    if (!privacyCheck.checked) {
                        alert('Debes aceptar la pol√≠tica de privacidad para enviar el formulario.');
                        return;
                    }
                    
                    // Obtener datos del formulario
                    const formData = new FormData(contactForm);
                    const nombre = formData.get('nombre') + ' ' + formData.get('apellidos');
                    const email = formData.get('email');
                    const telefono = formData.get('telefono') || '';
                    const asunto = formData.get('asunto');
                    const mensaje = formData.get('mensaje');
                    
                    // Validar campos obligatorios
                    if (!nombre || !email || !asunto || !mensaje) {
                        alert('Por favor, completa todos los campos obligatorios.');
                        return;
                    }
                    
                    // Validar email
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email)) {
                        alert('Por favor, introduce un email v√°lido.');
                        return;
                    }
                    
                    // Deshabilitar bot√≥n durante el env√≠o
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Enviando...';
                    
                    try {
                        console.log('Iniciando env√≠o del formulario...');
                        
                        // Obtener usuario actual si est√° logueado (con timeout)
                        console.log('Llamando a getCurrentUser...');
                        let currentUser = null;
                        try {
                            const timeoutPromise = new Promise((_, reject) => 
                                setTimeout(() => reject(new Error('Timeout')), 3000)
                            );
                            currentUser = await Promise.race([getCurrentUser(), timeoutPromise]);
                            console.log('Usuario actual recibido:', currentUser);
                        } catch (error) {
                            console.log('getCurrentUser fall√≥ o timeout, continuando sin usuario:', error.message);
                            currentUser = null;
                        }
                        
                        // Preparar datos para enviar
                        const contactData = {
                            user_id: currentUser?.id || null,
                            nombre: nombre.trim(),
                            email: email.trim(),
                            telefono: telefono.trim(),
                            asunto: asunto.trim(),
                            message: mensaje.trim()
                        };
                        console.log('Datos a enviar:', contactData);
                        
                        // Enviar formulario
                        console.log('Llamando a createFormContacto...');
                        const result = await createFormContacto(contactData);
                        console.log('Resultado de createFormContacto:', result);
                        
                        if (result.success) {
                            alert('¬°Formulario enviado correctamente! Nos pondremos en contacto contigo pronto.');
                            contactForm.reset();
                            privacyCheck.checked = false;
                        } else {
                            alert('Error al enviar el formulario: ' + result.error);
                        }
                    } catch (error) {
                        console.error('Error al enviar formulario:', error);
                        alert('Error inesperado al enviar el formulario. Por favor, intenta de nuevo.');
                    } finally {
                        // Rehabilitar bot√≥n
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Enviar';
                    }
                });
            }
            
            // Verificar estado inicial
            const currentUser = await getCurrentUser();
            updateAuthMenu(currentUser);
            
            // Escuchar cambios en autenticaci√≥n
            onAuthStateChange(async (event, session) => {
                if (event === 'SIGNED_IN' && session?.user) {
                    console.log('Usuario autenticado:', session.user);
                    
                    // Crear o actualizar perfil en tabla users
                    const profileResult = await createOrUpdateUserProfile(session.user);
                    
                    if (profileResult.success) {
                        console.log('Perfil procesado:', profileResult.action);
                        if (profileResult.action === 'created') {
                            console.log('Nuevo perfil creado para usuario de Google');
                        }
                    } else {
                        console.error('Error procesando perfil:', profileResult.error);
                    }
                    
                    updateAuthMenu(session.user);
                    // Autorrellenar formulario cuando el usuario inicia sesi√≥n
                    autoFillUserData();
                } else if (event === 'SIGNED_OUT') {
                    console.log('Usuario cerr√≥ sesi√≥n');
                    updateAuthMenu(null);
                    // Limpiar formulario cuando el usuario cierra sesi√≥n
                    if (contactForm) {
                        contactForm.reset();
                        // Hacer el email editable de nuevo
                        const emailInput = contactForm.querySelector('input[name="email"]');
                        if (emailInput) {
                            emailInput.readOnly = false;
                            emailInput.style.backgroundColor = '';
                        }
                    }
                }
            });
        });
    </script>
  </body>
</html>

